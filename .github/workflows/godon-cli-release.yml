name: Godon CLI Release Image

on:
  push:
    tags:
      - 'godon-cli-*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., godon-cli-0.1.0)'
        required: true
        type: string

permissions:
  packages: write
  contents: read

env:
  REGISTRY: ghcr.io
  ORG: godon-dev

jobs:
  build-and-release-image:
    if: ${{ startsWith(github.ref, 'refs/tags/godon-cli') || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set tag from ref
      if: github.event_name == 'push'
      run: |
        TAG="${{ github.ref_name }}"
        echo "TAG=$TAG" >> $GITHUB_ENV

    - name: Set tag from input
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV

    - name: Parse tag
      run: |
        TAG="${{ env.TAG }}"

        # Extract image name and version
        IMAGE_NAME="${TAG%-*}"  # Remove version part
        VERSION="${TAG##*-}"   # Remove image name part

        echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV

        echo "âœ… Parsed tag: $TAG"
        echo "ðŸ“¦ Image: $IMAGE_NAME"
        echo "ðŸ”– Version: $VERSION"

    - name: Verify version format
      run: |
        VERSION="${{ env.VERSION }}"
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Invalid version format: $VERSION"
          echo "Expected format: X.Y.Z (e.g., 0.1.0, 1.2.3)"
          exit 1
        fi
        echo "âœ… Version format validated: $VERSION"

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build container
      run: |
        export VERSION=${{ env.VERSION }}
        export IMAGE_NAME=${{ env.IMAGE_NAME }}
        cd images/${{ env.IMAGE_NAME }}
        bash ../../build/build-container-nix.sh --builder-file ../../build/Dockerfile.nix-builder

    - name: Test container
      run: |
        echo "Testing release container..."
        docker run --rm ${{ env.IMAGE_NAME }}:${{ env.VERSION }} --help

    - name: Tag for GitHub Container Registry
      run: |
        # Tag for GHCR
        docker tag ${{ env.IMAGE_NAME }}:${{ env.VERSION }} ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
        docker tag ${{ env.IMAGE_NAME }}:${{ env.VERSION }} ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.IMAGE_NAME }}:latest

    - name: Push to GitHub Container Registry
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
        docker push ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.IMAGE_NAME }}:latest

    - name: Create release summary
      run: |
        echo "## ðŸš€ Release Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: `${{ env.TAG }}`" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: `${{ env.VERSION }}`" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: `${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.IMAGE_NAME }}`" >> $GITHUB_STEP_SUMMARY
