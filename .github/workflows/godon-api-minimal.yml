name: Godon API Minimal
#

on:
  pull_request:
    branches: [ main ]
workflow_dispatch:

env:
  NIXPKGS_CHANNEL: https://nixos.org/channels/nixos-25.05

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      windmill-mock:
        image: stoplight/prism:4
        env:
          PRISM_LOG_LEVEL: info
        ports:
          - 8001:8001
        options: >-
          --name windmill-mock-service
          -v ${{ github.workspace }}/images/godon-api/tests/windmill-openapi.yaml:/tmp/openapi.yaml:ro
        cmd: mock -h 0.0.0.0 -p 8001 /tmp/openapi.yaml
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Nix
      uses: cachix/install-nix-action@v22
      with:
        nix_path: nixpkgs=${{ env.NIXPKGS_CHANNEL }}

    - name: Wait for Prism service
      run: |
        echo "Waiting for Prism mock service..."
        for i in {1..30}; do
          if curl -f http://localhost:8001/api/auth/login >/dev/null 2>&1; then
            echo "âœ… Prism mock service is ready!"
            break
          fi
          echo "Attempt $i/30 - waiting for Prism..."
          sleep 2
        done

    - name: Test Docker build
      run: |
        echo "Testing Docker operations..."
        docker --version
        echo "Docker operations work!"
