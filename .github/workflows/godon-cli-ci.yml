name: Build and Test godon-cli

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'images/godon-cli/**'
      - 'build/**'
  workflow_dispatch:
    inputs:
      VERSION:
        description: 'CLI version to test against (e.g., 0.1.0, main, develop)'
        required: false
        default: '0.2.0'

env:
  IMAGE_NAME: godon-cli

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get latest CLI version
      id: version
      run: |
        if [ -n "${{ github.event.inputs.VERSION }}" ]; then
          VERSION="${{ github.event.inputs.VERSION }}"
          echo "Using provided VERSION: $VERSION"
        else
          echo "Fetching latest release tag from godon-cli repo..."
          LATEST_TAG=$(curl -s https://api.github.com/repos/godon-dev/godon-cli/releases/latest | jq -r '.tag_name')
          if [ "$LATEST_TAG" = "null" ] || [ -z "$LATEST_TAG" ]; then
            echo "No release tags found, falling back to 0.2.0"
            VERSION="0.2.0"
          else
            VERSION="$LATEST_TAG"
            echo "Found latest tag: $VERSION"
          fi
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Build godon-cli container
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
      run: |
        export VERSION=${{ env.VERSION }}
        export IMAGE_NAME=${{ env.IMAGE_NAME }}
        export PROJECT_ROOT="$(git rev-parse --show-toplevel)"
        cd images/godon-cli
        bash ../../build/build-container-nix.sh --builder-file ../../build/Dockerfile.nix-builder

    - name: Test container invocation
      run: |
        echo "Testing godon-cli container..."
        VERSION="${{ steps.version.outputs.VERSION }}"

        # Test basic help command
        docker run --rm ${{ env.IMAGE_NAME }}:$VERSION --help

        echo "âœ… Container tests passed"

    - name: Show container info
      run: |
        echo "=== Container Information ==="
        VERSION="${{ steps.version.outputs.VERSION }}"
        docker images ${{ env.IMAGE_NAME }}:$VERSION
        echo ""
        echo "=== Container layers (top 10) ==="
        docker history ${{ env.IMAGE_NAME }}:$VERSION --human | head -10
