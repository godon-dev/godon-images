name: Godon API CI

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'images/godon-api/**'
      - 'shared/windmill_client/**'
      - 'shared/tests/**'
      - 'build/**'
      - '.github/workflows/godon-api-ci.yml'
  workflow_dispatch:

env:
  NIXPKGS_CHANNEL: https://nixos.org/channels/nixos-25.05

jobs:
  build-and-test:
    name: Build and Test Container
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup Nix
      uses: cachix/install-nix-action@v22
      with:
        nix_path: nixpkgs=https://nixos.org/channels/nixos-25.05

    - name: Build godon-api container with Nix
      run: |
        echo "Building godon-api container using established Nix build system..."
        cd images/godon-api
        VERSION="test-${{ github.run_number }}" \
        IMAGE_NAME="godon-api-test" \
        PROJECT_ROOT="$(git rev-parse --show-toplevel)" \
        ../../build/build-container-nix.sh \
          --version "test-${{ github.run_number }}" \
          --name "godon-api-test" \
          --builder-file ../../build/Dockerfile.nix-builder

    - name: Start Windmill test stack
      run: |
        echo "ðŸš€ Starting Windmill 1.601.1 test stack..."
        cd shared/tests
        docker compose -f docker-compose.windmill.yml -p godon-api-test up -d

        echo "â³ Waiting for Windmill to be ready (this takes ~60 seconds)..."
        sleep 60

        # Verify containers are running
        if ! docker ps | grep -q "godon-api-test-windmill_server-1"; then
          echo "âŒ Windmill server not running"
          docker ps
          docker logs godon-api-test-windmill_server-1
          exit 1
        fi
        echo "âœ… Windmill is running!"

    - name: Verify Windmill is ready
      run: |
        echo "ðŸ§ª Verifying Windmill is ready with retry..."

        MAX_RETRIES=20
        RETRY_DELAY=3

        for i in $(seq 1 $MAX_RETRIES); do
          echo "Attempt $i/$MAX_RETRIES..."

          if curl -s -f http://localhost:9101/ > /dev/null 2>&1; then
            echo "âœ… Windmill server is ready!"
            exit 0
          fi

          if [ $i -lt $MAX_RETRIES ]; then
            echo "â³ Windmill not ready, waiting ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          fi
        done

        echo "âŒ Windmill server failed to respond after $MAX_RETRIES attempts"
        docker logs godon-api-test-windmill_server-1
        exit 1

    - name: Deploy stub scripts
      run: |
        echo "ðŸ“ Deploying stub controller scripts..."
        cd shared/tests
        ./deploy-stubs.sh

    - name: Copy test data files
      run: |
        echo "ðŸ“ Copying test data files..."
        mkdir -p test-data
        cp shared/tests/stubs/test-data/*.yaml test-data/ 2>/dev/null || echo "No test data files found"

    - name: Start godon-api container
      run: |
        echo "ðŸš€ Starting godon-api container..."

        docker run -d --name godon-api-test \
          --network godon-api-test_default \
          -p 9090:9090 \
          -e WINDMILL_BASE_URL="http://windmill_server:8000/api" \
          -e WINDMILL_WORKSPACE="test" \
          -e WINDMILL_FOLDER="controller" \
          -e PORT="9090" \
          godon-api-test:test-${{ github.run_number }}

        echo "â³ Waiting for godon-api to start..."
        sleep 10

        # Verify godon-api is running
        if ! docker ps | grep -q "godon-api-test"; then
          echo "âŒ godon-api container not running"
          docker logs godon-api-test
          exit 1
        fi
        echo "âœ… godon-api is running!"

    - name: Test API health endpoint
      run: |
        echo "ðŸ¥ Testing health endpoint..."

        if curl -s -f http://localhost:9090/health > /dev/null; then
          echo "âœ… Health endpoint responding"
        else
          echo "âŒ Health endpoint not responding"
          docker logs godon-api-test
          exit 1
        fi

    - name: Pull godon_cli container for integration testing
      id: cli-image
      run: |
        echo "Pulling godon_cli container for integration testing..."

        CLI_CONTAINER_IMAGE="ghcr.io/godon-dev/godon-cli:latest"
        echo "Using CLI container image: $CLI_CONTAINER_IMAGE"

        echo "CLI_CONTAINER_IMAGE=$CLI_CONTAINER_IMAGE" >> $GITHUB_OUTPUT

        echo "Pulling godon_cli container $CLI_CONTAINER_IMAGE..."
        docker pull $CLI_CONTAINER_IMAGE

        # Test the container CLI mode
        echo "Testing godon_cli container in CLI mode..."
        docker run --rm $CLI_CONTAINER_IMAGE --help
        echo "âœ… godon_cli container ready for CLI mode"

    - name: Test breeder operations with godon_cli container
      run: |
        echo "Testing breeder operations via godon_cli container..."

        # Test breeder operations with godon_cli container
        echo "Testing breeder operations via godon_cli container..."

        # List breeders (should return stub data)
        echo "Listing breeders:"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure breeder list

        # Create a test breeder

        # Create a test breeder
        echo "Creating test breeder..."

        # Fetch example config from upstream godon repository
        curl -s https://raw.githubusercontent.com/godon-dev/godon/refs/heads/master/examples/network.yml -o breeder-config.yaml

        echo "Config file contents:"
        cat breeder-config.yaml

        docker run --rm --network godon-api-test_default \
          -v "$(pwd)/breeder-config.yaml:/breeder-config.yaml:ro" \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          breeder create --name="TestBreeder" --file=/breeder-config.yaml

        # List breeders again to see if creation worked
        echo "Listing breeders after creation:"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure breeder list

        # Test getting a specific breeder (using a sample UUID)
        echo "Testing get specific breeder:"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          breeder show --id=550e8400-e29b-41d4-a716-446655440000

        # Test updating a breeder
        echo "Testing update breeder:"
        # Fetch example config for update test
        curl -s https://raw.githubusercontent.com/godon-dev/godon/refs/heads/master/examples/network.yml -o update-config.yaml

        # Modify the config slightly to verify CLI reads it
        sed -i 's/parallel: 1/parallel: 2/' update-config.yaml

        echo "Update config file contents:"
        cat update-config.yaml

        # Test breeder update - should return NOT_IMPLEMENTED
        echo "Testing update breeder (should return NOT_IMPLEMENTED):"
        docker run --rm --network godon-api-test_default \
          -v "$(pwd)/update-config.yaml:/update-config.yaml:ro" \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          breeder update --file=/update-config.yaml \
          || echo "âœ… Update correctly returned NOT_IMPLEMENTED as expected"

        # Test deleting a breeder
        echo "Testing delete breeder:"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          breeder purge --id=550e8400-e29b-41d4-a716-446655440000

        # Test error scenarios
        echo "Testing error scenarios..."

        # Test with invalid UUID (using show command) - this should fail
        echo "Testing invalid UUID handling (should fail):"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          breeder show --id=invalid-uuid-format || echo "âœ… Invalid UUID properly rejected"

        # Test with non-existent breeder (should fail)
        echo "Testing non-existent breeder (should fail):"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          breeder show --id=00000000-0000-4000-8000-000000000000 || echo "âœ… Non-existent breeder properly handled"

    - name: Test credential operations with godon_cli container
      run: |
        echo "Testing credential operations via godon_cli container..."

        # List credentials (should return stub data)
        echo "Listing credentials:"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure credential list

        # Verify list can be parsed as JSON array
        echo "Verifying credential list structure:"
        CRED_LIST_OUTPUT=$(docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure credential list 2>/dev/null)
        if echo "$CRED_LIST_OUTPUT" | jq -e 'if type == "array" then true else false end' > /dev/null 2>&1; then
          echo "âœ… Credential list returns proper JSON array"
        else
          echo "âš ï¸  Credential list format unclear (might be wrapped)"
          echo "Output was: $CRED_LIST_OUTPUT"
        fi

        # Create a test credential
        echo "Creating test credential..."
        echo 'name: "test-ssh-key"' > credential-config.yaml
        echo 'credentialType: "ssh_private_key"' >> credential-config.yaml
        echo 'description: "Test SSH key for CI"' >> credential-config.yaml
        echo 'content: "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA2Z9Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2Q2\n2Q2Q2QwIDAQABAoIBAFQ==\n-----END RSA PRIVATE KEY-----"' >> credential-config.yaml

        docker run --rm --network godon-api-test_default \
          -v "$(pwd)/credential-config.yaml:/credential-config.yaml:ro" \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          credential create --file=/credential-config.yaml

        # List credentials again to see if creation worked
        echo "Listing credentials after creation:"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure credential list

        # Test getting a specific credential (using UUID of created credential)
        echo "Testing get specific credential:"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          credential show --id=550e8400-e29b-41d4-a716-446655440011

        # Test deleting a credential
        echo "Testing delete credential:"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          credential delete --id=550e8400-e29b-41d4-a716-446655440011

        # Test credential error scenarios
        echo "Testing credential error scenarios..."

        # Test with invalid UUID format
        echo "Testing invalid UUID handling for credentials (should fail):"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          credential show --id=invalid-uuid-format || echo "âœ… Invalid UUID properly rejected"

        # Test with non-existent credential
        echo "Testing non-existent credential (should fail):"
        docker run --rm --network godon-api-test_default \
          ${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }} \
          --hostname=godon-api-test --port=9090 --insecure \
          credential show --id=00000000-0000-4000-8000-000000000000 || echo "âœ… Non-existent credential properly handled"

    - name: Adversarial API Tests
      run: |
        echo "ðŸš¨ Running adversarial API tests..."

        CLI_CONTAINER_IMAGE="${{ steps.cli-image.outputs.CLI_CONTAINER_IMAGE }}"

        # Test 1: Response structure validation
        echo "Test 1: Validating breeder show response structure..."
        SHOW_OUTPUT=$(docker run --rm --network godon-api-test_default \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          breeder show --id=550e8400-e29b-41d4-a716-446655440000 2>/dev/null)

        # CLI outputs formatted text, so check for expected field names in the output
        if echo "$SHOW_OUTPUT" | grep -q "ID:" && echo "$SHOW_OUTPUT" | grep -q "Name:" && echo "$SHOW_OUTPUT" | grep -q "Status:"; then
          echo "âœ… Breeder show returns proper object structure"
        else
          echo "âŒ Breeder show response structure incorrect"
          echo "Output was: $SHOW_OUTPUT"
          exit 1
        fi

        # Test 2: Empty string ID
        echo "Test 2: Testing empty string ID..."
        docker run --rm --network godon-api-test_default \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          breeder show --id="" || echo "âœ… Empty ID properly rejected"

        # Test 3: Delete then get verification
        echo "Test 3: Testing delete-then-get flow..."
        TEST_ID="550e8400-e29b-41d4-a716-446655440000"
        docker run --rm --network godon-api-test_default \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          breeder purge --id=$TEST_ID || echo "âš ï¸  Delete failed (might not exist)"

        docker run --rm --network godon-api-test_default \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          breeder show --id=$TEST_ID || echo "âœ… Deleted breeder properly inaccessible"

        # Test 4: Special characters in names
        echo "Test 4: Testing special characters in names..."
        docker run --rm --network godon-api-test_default \
          -v "$(pwd)/test-data/breeder-minimal.yaml:/breeder-config.yaml:ro" \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          breeder create --name="test with spaces" --file=/breeder-config.yaml || echo "âœ… Spaces in name properly rejected"

        # Test 5: Excessively long ID
        echo "Test 5: Testing excessively long ID..."
        LONG_ID=$(printf 'a%.0s' {1..1000})
        docker run --rm --network godon-api-test_default \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          breeder show --id="$LONG_ID" || echo "âœ… Overly long ID properly rejected"

        # Test 6: Response time checks
        echo "Test 6: Testing response times..."
        START_TIME=$(date +%s%N)
        docker run --rm --network godon-api-test_default \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          breeder list > /dev/null 2>&1
        END_TIME=$(date +%s%N)
        DURATION=$(( ($END_TIME - $START_TIME) / 1000000 ))
        if [ $DURATION -gt 5000 ]; then
          echo "âš ï¸  Response time high: ${DURATION}ms"
        else
          echo "âœ… Response time acceptable: ${DURATION}ms"
        fi

        # Test 7: Credential create with invalid type
        echo "Test 7: Testing invalid credential type..."
        docker run --rm --network godon-api-test_default \
          -v "$(pwd)/test-data/credential-invalid-type.yaml:/credential-config.yaml:ro" \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          credential create --file=/credential-config.yaml || echo "âœ… Invalid type properly rejected"

        # Test 8: Missing required fields
        echo "Test 8: Testing missing required fields..."
        docker run --rm --network godon-api-test_default \
          -v "$(pwd)/test-data/credential-missing-fields.yaml:/credential-config.yaml:ro" \
          $CLI_CONTAINER_IMAGE --hostname=godon-api-test --port=9090 --insecure \
          credential create --file=/credential-config.yaml || echo "âœ… Missing fields properly rejected"

        echo "âœ… All adversarial tests completed"

    - name: Test API endpoints with curl
      run: |
        echo "Testing API endpoints with curl for fallback comparison..."

        echo "Health endpoint:"
        curl -s http://localhost:9090/health | jq .

        echo "Root endpoint:"
        curl -s http://localhost:9090/ | jq .

    - name: Show container logs on failure
      if: failure()
      run: |
        echo "ðŸ“‹ Showing godon-api logs..."
        docker logs godon-api-test

        echo ""
        echo "ðŸ“‹ Showing Windmill server logs..."
        docker logs godon-api-test-windmill_server-1

    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        docker stop godon-api-test 2>/dev/null || true
        docker rm godon-api-test 2>/dev/null || true
        cd shared/tests
        docker compose -f docker-compose.windmill.yml -p godon-api-test down -v
