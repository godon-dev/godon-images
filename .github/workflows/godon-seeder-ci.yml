name: Godon Seeder CI

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'images/godon-seeder/**'
      - 'shared/windmill_client/**'
      - 'build/**'
      - '.github/workflows/godon-seeder-ci.yml'
  workflow_dispatch:

env:
  NIXPKGS_CHANNEL: https://nixos.org/channels/nixos-25.05

jobs:
  build-and-test:
    name: Build and Test Container
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup Nix
      uses: cachix/install-nix-action@v22
      with:
        nix_path: nixpkgs=https://nixos.org/channels/nixos-25.05

    - name: Build godon-seeder container with Nix
      run: |
        echo "Building godon-seeder container using established Nix build system..."
        cd images/godon-seeder
        VERSION="test-${{ github.run_number }}" \
        IMAGE_NAME="godon-seeder-test" \
        PROJECT_ROOT="$(git rev-parse --show-toplevel)" \
        ../../build/build-container-nix.sh \
          --version "test-${{ github.run_number }}" \
          --name "godon-seeder-test" \
          --builder-file ../../build/Dockerfile.nix-builder

    - name: Test container basic functionality
      run: |
        echo "Testing container basic functionality..."
        
        # Test container help command by overriding entrypoint
        docker run --rm --entrypoint="/bin/sh" godon-seeder-test:test-${{ github.run_number }} -c "godon_seeder --help"

    - name: Run Prism mock server and test seeder deployment
      run: |
        echo "üß™ Testing godon-seeder against Prism mock server..."
        
        # Start Prism mock server
        echo "üì° Starting Prism mock server on port 8000..."
        docker run -d --name windmill-mock \
          -p 8000:4010 \
          -v "$(pwd)/shared/windmill-openapi.yaml:/spec.yaml:ro" \
          stoplight/prism:5 \
          mock -h 0.0.0.0 -p 4010 /spec.yaml --dynamic --errors=false
        
        echo "‚è≥ Waiting for Prism to initialize..."
        sleep 15
        
        # Verify Prism is running
        echo "üîç Verifying Prism mock server..."
        if ! docker ps | grep windmill-mock > /dev/null; then
          echo "‚ùå Prism mock container not running"
          docker logs windmill-mock
          exit 1
        fi
        echo "‚úÖ Prism mock server is ready!"
        
        # Test script creation endpoint
        echo "üß™ Testing script creation endpoint..."
        curl -s -X POST http://localhost:8000/w/test/scripts/create \
          -H "Authorization: Bearer test" \
          -H "Content-Type: application/json" \
          -d '{"path":"f/test.py","content":"def main(): pass","language":"python3","summary":"test","description":"test script"}' | head -5
        
        # Find the seeder binary path
        echo "üîç Finding seeder binary path..."
        BINARY_PATH=$(docker run --rm --entrypoint=/bin/sh godon-seeder-test:test-${{ github.run_number }} -c "find /nix/store -name 'godon_seeder' -type f | head -1")
        echo "Found binary at: $BINARY_PATH"

        # Run seeder test against mock server using actual repositories
        echo "üöÄ Running godon-seeder test with actual repositories..."
        docker run --rm \
          --network host \
          -e WINDMILL_BASE_URL=http://localhost:8000 \
          -e WINDMILL_WORKSPACE=test-workspace \
          -e WINDMILL_EMAIL=admin@test.com \
          -e WINDMILL_PASSWORD=test123 \
          -e CONTROLLER_REPO=https://github.com/godon-dev/godon-controller.git \
          -e CONTROLLER_VERSION=0.3.0 \
          -e BREEDER_REPO=https://github.com/godon-dev/godon-breeders.git \
          -e BREEDER_VERSION=0.7.0 \
          -e GODON_DIR=/var/lib/godon \
          -e VERBOSE=true \
          godon-seeder-test:test-${{ github.run_number }}

        echo "‚úÖ Seeder test completed successfully!"

    - name: Test retry mechanism with delayed Prism start
      run: |
        echo "üß™ Testing retry mechanism with delayed Windmill availability..."

        # Start seeder before Prism is ready to test retry logic
        echo "Starting seeder with 5 retries, 2s delay..."
        docker run -d --name seeder-retry-test \
          --network host \
          -e WINDMILL_BASE_URL=http://localhost:8100 \
          -e WINDMILL_WORKSPACE=test-workspace \
          -e WINDMILL_EMAIL=admin@test.com \
          -e WINDMILL_PASSWORD=test123 \
          -e CONTROLLER_REPO=https://github.com/godon-dev/godon-controller.git \
          -e CONTROLLER_VERSION=0.1.0 \
          -e BREEDER_REPO=https://github.com/godon-dev/godon-breeders.git \
          -e BREEDER_VERSION=0.1.0 \
          -e GODON_DIR=/var/lib/godon \
          -e SEEDER_MAX_RETRIES=5 \
          -e SEEDER_RETRY_DELAY=2 \
          -e VERBOSE=true \
          godon-seeder-test:test-${{ github.run_number }}

        echo "‚è≥ Seeder started, waiting 2s before starting Prism..."
        sleep 2

        echo "üì° Now starting Prism mock server on port 8100 for retry test..."
        docker run -d --name windmill-mock-retry \
          -p 8100:4010 \
          -v "$(pwd)/shared/windmill-openapi.yaml:/spec.yaml:ro" \
          stoplight/prism:5 \
          mock -h 0.0.0.0 -p 4010 /spec.yaml --dynamic --errors=false

        echo "‚è≥ Waiting for Prism to initialize and seeder to complete..."
        sleep 10

        echo "üìä Seeder logs (should show retry attempts):"
        docker logs seeder-retry-test

        # Check if seeder succeeded
        if docker inspect seeder-retry-test --format='{{.State.Status}}' | grep -q "exited"; then
          exit_code=$(docker inspect seeder-retry-test --format='{{.State.ExitCode}}')
          if [ "$exit_code" = "0" ]; then
            echo "‚úÖ Retry mechanism test passed!"
          else
            echo "‚ùå Retry mechanism test failed with exit code: $exit_code"
            exit 1
          fi
        else
          echo "‚ö†Ô∏è  Seeder still running, checking logs..."
          docker logs seeder-retry-test
          exit 1
        fi

    - name: Container cleanup
      if: always()
      run: |
        echo "Cleaning up test containers..."
        docker rmi godon-seeder-test:test-${{ github.run_number }} || true
