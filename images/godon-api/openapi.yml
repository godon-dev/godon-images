---
# Copyright (c) 2019 Matthias Tafelmeier.
#
# This file is part of godon
#
# godon is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# godon is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this godon. If not, see <http://www.gnu.org/licenses/>.

openapi: 3.0.0
info:
  version: 0.0.0
  title: Godon Control API
  description: |
    RESTful API for controlling and managing the godon optimizer breeders.
    This API allows you to create, read, update, and delete breeder configurations.
  contact:
    name: Godon Development Team
    url: https://github.com/godon-dev
  license:
    name: GNU Affero General Public License v3.0
    url: https://www.gnu.org/licenses/agpl-3.0.html

servers:
  - url: /v0
    description: Lab server v0

tags:
  - name: breeders
    description: Operations for managing optimizer breeders
  - name: credentials
    description: Operations for managing credential catalog

paths:
  /breeders:
    get:
      tags:
        - breeders
      operationId: listBreeders
      summary: List all breeders
      description: Retrieves a list of all configured optimizer breeders
      responses:
        '200':
          description: Successfully returned list of configured breeders
          content:
            application/json:
              schema:
                type: object
                properties:
                  breeders:
                    type: array
                    items:
                      $ref: '#/components/schemas/BreederSummary'
              examples:
                breeders:
                  summary: Example list of breeders
                  value:
                    - id: "550e8400-e29b-41d4-a716-446655440000"
                      name: "genetic-optimizer-1"
                      status: "active"
                      createdAt: "2024-01-15T10:30:00Z"
                    - id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
                      name: "neural-breeder-2"
                      status: "paused"
                      createdAt: "2024-01-16T14:20:00Z"
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - breeders
      operationId: createBreeder
      summary: Create a new breeder
      description: Creates a new optimizer breeder with the provided configuration
      requestBody:
        required: true
        description: Breeder configuration details
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BreederCreate'
            examples:
              basic:
                summary: Basic breeder configuration
                value:
                  name: "genetic-optimizer-1"
      responses:
        '201':
          description: Successfully created the breeder
          content:
            application/json:
              schema:
                type: object
                properties:
                  breeder:
                    $ref: '#/components/schemas/BreederSummary'
              examples:
                created:
                  summary: Newly created breeder
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "genetic-optimizer-1"
                    status: "active"
                    createdAt: "2024-01-15T10:30:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /breeders/{uuid}:
    parameters:
      - $ref: '#/components/parameters/BreederUuid'

    get:
      tags:
        - breeders
      operationId: getBreeder
      summary: Get breeder by ID
      description: Retrieves detailed information about a specific breeder
      responses:
        '200':
          description: Successfully returned breeder information
          content:
            application/json:
              schema:
                type: object
                properties:
                  breeder:
                    $ref: '#/components/schemas/Breeder'
              examples:
                breeder:
                  summary: Example breeder details
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "genetic-optimizer-1"
                    status: "active"
                    createdAt: "2024-01-15T10:30:00Z"
                    config: "{}"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - breeders
      operationId: updateBreeder
      summary: Update breeder configuration
      description: Updates the configuration of an existing breeder
      requestBody:
        required: true
        description: Updated breeder configuration
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BreederUpdate'
            examples:
              update:
                summary: Updated breeder configuration
                value:
                  name: "updated-genetic-optimizer"
                  description: "Updated optimizer configuration"
                  config:
                    setting1: "new_value1"
                    setting2: 200

      responses:
        '200':
          description: Successfully updated the breeder
          content:
            application/json:
              schema:
                type: object
                properties:
                  breeder:
                    $ref: '#/components/schemas/Breeder'
              examples:
                updated:
                  summary: Updated breeder
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "updated-genetic-optimizer"
                    status: "active"
                    createdAt: "2024-01-15T10:30:00Z"
                    config:
                      setting1: "new_value1"
                      setting2: 200
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '501':
          $ref: '#/components/responses/NotImplementedServerError'

    delete:
      tags:
        - breeders
      operationId: deleteBreeder
      summary: Delete a breeder
      description: Permanently removes a breeder and its configuration
      responses:
        '200':
          description: Successfully deleted the breeder
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
              examples:
                deleted:
                  summary: Deletion confirmation
                  value:
                    message: "Breeder 550e8400-e29b-41d4-a716-446655440000 successfully deleted"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /credentials:
    get:
      tags:
        - credentials
      operationId: listCredentials
      summary: List all credentials
      description: Retrieves a list of all credentials in the catalog
      responses:
        '200':
          description: Successfully returned list of credentials
          content:
            application/json:
              schema:
                type: object
                properties:
                  credentials:
                    type: array
                    items:
                      $ref: '#/components/schemas/Credential'
              examples:
                credentials:
                  summary: Example credentials list
                  value:
                    - id: "550e8400-e29b-41d4-a716-446655440001"
                      name: "production_ssh_key"
                      credential_type: "ssh_private_key"
                      description: "SSH key for production servers"
                      windmill_variable: "f/vars/prod_ssh_key"
                      created_at: "2024-01-15T10:30:00Z"
                    - id: "6ba7b810-9dad-11d1-80b4-00c04fd430c9"
                      name: "staging_ssh_key"
                      credential_type: "ssh_private_key"
                      description: "SSH key for staging environment"
                      windmill_variable: "f/vars/staging_ssh_key"
                      created_at: "2024-01-16T14:20:00Z"
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - credentials
      operationId: createCredential
      summary: Create a new credential
      description: |
        Creates a new credential catalog entry and stores the credential content in Windmill.
        The credential content is sent over the provided HTTPS transport and stored encrypted
        in Windmill's workspace (per-workspace symmetric encryption).
      requestBody:
        required: true
        description: Credential details including the actual credential content
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CredentialCreate'
            examples:
              sshKey:
                summary: SSH private key credential
                value:
                  name: "production_ssh_key"
                  credential_type: "ssh_private_key"
                  description: "SSH key for production servers"
                  content: "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA2Z2H7V..."
      responses:
        '201':
          description: Successfully created the credential
          content:
            application/json:
              schema:
                type: object
                properties:
                  credential:
                    $ref: '#/components/schemas/Credential'
              examples:
                created:
                  summary: Newly created credential
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440001"
                    name: "production_ssh_key"
                    credential_type: "ssh_private_key"
                    description: "SSH key for production servers"
                    windmill_variable: "f/vars/prod_ssh_key"
                    created_at: "2024-01-15T10:30:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /credentials/{credential_id}:
    parameters:
      - $ref: '#/components/parameters/CredentialId'

    get:
      tags:
        - credentials
      operationId: getCredential
      summary: Get credential by ID
      description: Retrieves detailed information about a specific credential including the actual content
      responses:
        '200':
          description: Successfully returned credential information with content
          content:
            application/json:
              schema:
                type: object
                properties:
                  credential:
                    $ref: '#/components/schemas/Credential'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - credentials
      operationId: deleteCredential
      summary: Delete a credential
      description: |
        Permanently removes a credential from both the godon catalog and Windmill.
        This operation cannot be undone.
      responses:
        '200':
          description: Successfully deleted the credential
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
              examples:
                deleted:
                  summary: Deletion confirmation
                  value:
                    message: "Credential 550e8400-e29b-41d4-a716-446655440001 successfully deleted"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  parameters:
    BreederUuid:
      name: uuid
      in: path
      required: true
      description: Unique identifier (UUID v4) for the breeder
      schema:
        type: string
        format: uuid
        pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$'
      example: "550e8400-e29b-41d4-a716-446655440000"

    CredentialId:
      name: credential_id
      in: path
      required: true
      description: Unique identifier (UUID v4) for the credential
      schema:
        type: string
        format: uuid
        pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$'
      example: "550e8400-e29b-41d4-a716-446655440001"

  schemas:
    Breeder:
      type: object
      required:
        - id
        - name
        - status
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the breeder
          readOnly: true
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-zA-Z0-9_-]+$'
          description: Human-readable name for the breeder (alphanumeric, hyphens, and underscores only)
          example: "genetic-optimizer-1"
        status:
          type: string
          enum: [active, paused, stopped, error]
          description: Current operational status of the breeder
          example: "active"
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the breeder was created
          readOnly: true
          example: "2024-01-15T10:30:00Z"
        config:
          type: object
          description: Configuration object for the breeder
          additionalProperties: true
          example:
            setting1: "value1"
            setting2: 42
            optimization_target: "performance"

    BreederSummary:
      type: object
      required:
        - id
        - name
        - status
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the breeder
          readOnly: true
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-zA-Z0-9_-]+$'
          description: Human-readable name for the breeder (alphanumeric, hyphens, and underscores only)
          example: "genetic-optimizer-1"
        status:
          type: string
          enum: [active, paused, stopped, error]
          description: Current operational status of the breeder
          example: "active"
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the breeder was created
          readOnly: true
          example: "2024-01-15T10:30:00Z"

    BreederCreate:
      type: object
      required:
        - name
        - config
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Human-readable name for the breeder
          example: "genetic-optimizer-1"
        config:
          type: object
          description: Configuration object for the breeder
          additionalProperties: true

    BreederUpdate:
      type: object
      required:
        - name
        - description
        - config
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Human-readable name for the breeder
          example: "updated-genetic-optimizer"
        description:
          type: string
          description: Description of the breeder updates
          example: "Updated optimizer configuration"
        config:
          type: object
          description: Updated configuration object for the breeder
          additionalProperties: true

    BreederList:
      type: array
      items:
        $ref: '#/components/schemas/BreederSummary'
      description: Array of breeder summary objects (without configuration details)

    Error:
      type: object
      required:
        - message
        - code
      properties:
        message:
          type: string
          description: Human-readable error message
          example: "Invalid request parameters"
        code:
          type: string
          description: Machine-readable error code
          example: "INVALID_INPUT"
        details:
          type: object
          description: Additional error details and context
          additionalProperties: true
          example:
            field: "name"
            reason: "Name must be between 1 and 255 characters"

    SuccessMessage:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Human-readable success message
          example: "Operation completed successfully"

    Credential:
      type: object
      required:
        - id
        - name
        - credential_type
        - windmill_variable
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the credential
          readOnly: true
          example: "550e8400-e29b-41d4-a716-446655440001"
        name:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-zA-Z0-9_-]+$'
          description: Human-readable name for the credential (alphanumeric, hyphens, and underscores only)
          example: "production_ssh_key"
        credential_type:
          type: string
          enum: ["ssh_private_key", "api_token", "database_connection", "http_basic_auth"]
          description: Type of credential
          example: "ssh_private_key"
        description:
          type: string
          description: Human-readable description of the credential's purpose
          example: "SSH key for production servers"
        windmill_variable:
          type: string
          description: Path to the corresponding Windmill variable (auto-generated from name)
          readOnly: true
          example: "f/vars/prod_ssh_key"
        created_at:
          type: string
          format: date-time
          description: Timestamp when the credential was created
          readOnly: true
          example: "2024-01-15T10:30:00Z"
        last_used_at:
          type: string
          format: date-time
          description: Timestamp when the credential was last accessed
          readOnly: true
          example: "2024-01-16T14:20:00Z"
        content:
          type: string
          description: The actual credential content (only included in GET /credentials/{id} responses)
          example: "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA2Z2H7V..."

    CredentialCreate:
      type: object
      required:
        - name
        - credential_type
        - content
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-zA-Z0-9_-]+$'
          description: Human-readable name for the credential
          example: "production_ssh_key"
        credential_type:
          type: string
          enum: ["ssh_private_key", "api_token", "database_connection", "http_basic_auth"]
          description: Type of credential being stored
          example: "ssh_private_key"
        description:
          type: string
          description: Human-readable description of the credential's purpose
          example: "SSH key for production servers"
        content:
          type: string
          description: |
            The actual credential content (e.g., private key content, API token, etc.).
            This is sent over HTTPS and stored encrypted in Windmill's per-workspace encryption.
          example: "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA2Z2H7V..."

    CredentialList:
      type: array
      items:
        $ref: '#/components/schemas/Credential'
      description: Array of credential objects (excluding the actual credential content)

  responses:
    BadRequest:
      description: Invalid request parameters or malformed request body
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            invalidInput:
              summary: Invalid input validation
              value:
                message: "Invalid request parameters"
                code: "INVALID_INPUT"
                details:
                  field: "name"
                  reason: "Name is required and must contain only alphanumeric characters, hyphens, and underscores (no spaces)"

    NotFound:
      description: The requested resource was not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            notFound:
              summary: Breeder not found
              value:
                message: "Breeder not found"
                code: "NOT_FOUND"
                details:
                  uuid: "550e8400-e29b-41d4-a716-446655440000"

    Conflict:
      description: Resource conflict (e.g., duplicate name)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            duplicate:
              summary: Duplicate breeder name
              value:
                message: "A breeder with this name already exists"
                code: "DUPLICATE_RESOURCE"
                details:
                  field: "name"
                  value: "genetic-optimizer-1"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            serverError:
              summary: Unexpected server error
              value:
                message: "An unexpected error occurred"
                code: "INTERNAL_SERVER_ERROR"

    NotImplementedServerError:
      description: Not Implented
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            serverError:
              summary: Not implemented
              value:
                message: "Not implemented on server side"
                code: "NOT_IMPLEMENTED_ERROR"

